# Auth

The _Auth_ component provides Intecture with a trusted certificate store and authentication services.

## Certificate store

The certificate store is a directory on the _Auth_ server, elected by the configuration key `cert_path` (see [auth.json](ch05-03-02-reference-auth-json.html)). This directory stores plaintext user and host public key certificates.

> While it would seem sensible to store certificates in an encrypted format, the _Auth_ server **only** stores public keys, which would not be of any assistance to an attacker.

### Certificate format

The _Auth_ server stores certificates in the format generated by ZeroMQ. A public key certificate looks a bit like this:

```
#   ...ignore the pre-generated comments...

metadata
    name = "pete"
    type = "user"
curve
    public-key = "eJ}lH?1OcEtI(8YKAyZN+H/w}vWo=W^)xPU7oL?X"
```

You can ignore the comments at the top of the file. That's pre-generated by ZeroMQ and doesn't apply to Intecture. The important parts are the `metadata` and `curve` arrays.

#### `metadata`

- `name` The username or hostname, depending on the certificate type
- `type` The certificate type - either "host" or "user"

#### `curve`

- `public-key` The user's/host's public key

## Endpoints

### API endpoint

The API endpoint allows the _API_ and _CLI_ components to query the certificate store, and create or delete certificates.

### Update endpoint

The Update endpoint publishes user certificate additions/deletions, which the _Agent_ uses for maintaining a volatile cache of user public keys.

### Security

Socket listeners, like those used by the _Auth_ service, add an attack surface to your hosts. Read the section on [Attack Surfaces](ch04-01-security-attack.html#2.%20Socket%20listeners) for more information and advice.

## Workflow

Each component interacts with the _Auth_ service differently, so let's break them down:

### Agent

The _Agent_ service connects to the _Auth_ service's Update endpoint on start. When it does this, the _Auth_ server will send a full list of user public keys. In the event that a user is created or deleted on the _Auth_ server, it will publish an update immmediately to the Update endpoint, which the _Agent_ is subscribed to.

<p style="text-align: center;">
  <img alt="Connection sequence" src="diagrams/ch05-03-auth-agent.msc.svg">
</p>

### API

The _API_ uses the _Auth_ service's API endpoint to query the certificate store. Specifically the _API_ queries the _Auth_ service before it connects to a host, to retrieve the host's public key. It does not cache this key so will make a query every time it creates a new host connection.

<p style="text-align: center;">
  <img alt="Connection sequence" src="diagrams/ch05-03-auth-api.msc.svg">
</p>

### CLI

The _CLI_ also uses the _Auth_ service's API endpoint to query the certificate store. The _CLI_ allows users to query a list of hosts/users stored in the certificate store, as well as create and delete certificates. If you create or delete a user certificate, the _Auth_ service will publish the change for the benefit of _Agents_.

<p style="text-align: center;">
  <img alt="Connection sequence" src="diagrams/ch05-03-auth-cli.msc.svg">
</p>
